---
title: "Case_Study_EDA"
author: "Aurian Ghaemmaghami"
date: "2/22/2020"
output: html_document
---

options(max.print=10000)

#Load in packages
library(ggplot2)
library(dplyr)
library(naniar)
library(stringr)
library(htmlwidgets)

#Read in Beers CSV
beer = read.csv(file.choose(), header=TRUE)

#Read in Breweries CSV
brew = read.csv(file.choose(), header=TRUE)


##Question 1

#How many Breweries present in each state
brew %>%
  select(State)%>%
  ggplot(aes(x=State, fill = State))+
  geom_bar()+
  geom_text(stat='count', aes(label=..count..), vjust=-0.5)


##Question 2

#Change brewery label so it matches beer df
names(brew)[1] = "Brewery_id"

#Change brewery IDs to factors
beer$Brewery_id = as.factor(beer$Brewery_id)
brew$Brewery_id = as.factor(brew$Brewery_id)

#Join DF by Brewery ID's and show top and bottom 6
df = inner_join(beer,brew, by = "Brewery_id")

#Print top 6 observations of merged beer data frames
head(df)

#Print bottom 6 observations of merged beer data frames
tail(df)


##Question 3

#Check for NA's... we can see ABV and IBU have NA's only
#1005 Missing Values for IBU
#62 Missing Values for ABC
gg_miss_var(df)
ibuc = df %>% filter(!is.na(IBU))
abvc = df %>% filter(!is.na(ABV))
dim(df)[1] - dim(ibuc)[1]
dim(df)[1] - dim(abvc)[1]


##Question 4

#Compute median ABV and IBU for reach state. Then compare with bar chart. Handle NA's
df %>%
  filter(!is.na(ABV) & !is.na(IBU))%>%
  group_by(State)%>%
  summarize(MedianABV = median(ABV), medianIBU = median(IBU))%>%
  print(n=50)

#Create bar chart of median ABV for each State
df %>%
  filter(!is.na(ABV) & !is.na(IBU))%>%
  group_by(State)%>%
  summarize(MedianABV = median(ABV), MedianIBU = median(IBU))%>%
  ggplot(aes(x=State, y = MedianABV, fill=State))+
  geom_bar(stat="identity")
  
#Create bar chart of median IBU for each State
df %>%
  filter(!is.na(ABV) & !is.na(IBU))%>%
  group_by(State)%>%
  summarize(MedianABV = median(ABV), MedianIBU = median(IBU))%>%
  ggplot(aes(x=State, y = MedianIBU, fill=State))+
  geom_bar(stat="identity")


##Question 5

#Which state has the HIGHEST ABV
#Highest ABV - Colorado!!
df %>%
  filter(!is.na(ABV))%>%
  group_by(State)%>%
  summarize(MaxABV = max(ABV))%>%
  ggplot(aes(x=State, y = MaxABV, fill=State))+
  geom_bar(stat="identity")

#What value is the ABV for Colorado
#Lee Hill Series Vol. 5 - Belgian Style Quadrupel Ale @ 0.128
coloradodf = df %>% filter(State == " CO")
coloradodf = coloradodf[order(coloradodf$ABV, decreasing=TRUE),]
head(coloradodf,1)

#Highest IBU is Oregon
df %>%
  filter(!is.na(IBU))%>%
  group_by(State)%>%
  summarize(MaxIBU = max(IBU))%>%
  ggplot(aes(x=State, y = MaxIBU, fill=State))+
  geom_bar(stat="identity")

#What value is the IBU for Oregon
#Oregon Bitter Bitch Imperial IPA - 138
oregondf = df %>% filter(State == " OR")
oregondf = oregondf[order(oregondf$IBU, decreasing=TRUE),]
head(oregondf,1)


##Question 6

#Distribution of ABV variable
#Distribution looks slightly right skewed
df %>%
  filter(!is.na(ABV))%>%
  ggplot(aes(x=ABV))+
  geom_histogram(fill="blue", col= "red")

#Summary stats of ABV variable
df%>%
  filter(!is.na(ABV))%>%
  summarize(MeanABV = mean(ABV), SDABV = sd(ABV), MedianABV = median(ABV), MaxABV = max(ABV), MinABV = min(ABV), count = n())


##Question 7

#Relationship between ABV and IBV(Bitterness)?
#We can see a positive linear correlation with IBU and ABV.
#AS the bitterness is higher, the ABV usually increases as well.
#This makes sense since the higher percentage of alcohol will most
#likely make your drink more bitter
df %>%
  filter(!is.na(ABV) & !is.na(IBU))%>%
  ggplot(aes(x=IBU, y=ABV))+
  geom_point()+
  geom_smooth(method="lm", col = "blue")+
  ggtitle("Relationship between IBU and ABV")


##Question 8

#KNN Classification of IPA or Ale based on IBU and ABV explanatory variables
#Filter out Ale and IPA only
Aledf = df %>% filter(grepl("Ale",df$Style))
IPAdf = df %>% filter(grepl("IPA",df$Style))

#Create new DF
AleIPA = full_join(IPAdf,Aledf)
names(AleIPA)[1] = "Name"
names(AleIPA)[8] = "Brewery"

#KNN
library(class)
library(caret)
library(e1071)

#Create new column of factors for Ale and IPA
Style_Type = c()
for(i in grepl("Ale",AleIPA$Style))
  {
  if(i == "TRUE")
    {
    Style_Type = c(Style_Type,"Ale")
    }else{
    Style_Type = c(Style_Type,"IPA")
    }
}

#Bind column to df
AleIPA = cbind(AleIPA,Style_Type)

#Turn Style_Type to factor
AleIPA$Style_Type = as.factor(AleIPA$Style_Type)

#Turn IBU to numeric
AleIPA$IBU = as.numeric(AleIPA$IBU)
str(AleIPA)
summary(AleIPA)
dim(AleIPA)

#Check missing values
gg_miss_var(AleIPA)

#Filter them out to do training on data set
AleIPA = AleIPA %>% filter(!is.na(ABV) & !is.na(IBU))
dim(AleIPA)

##70/30 Test Train Set for kNN
splitPerc = .80
iterations = 200
numks = 90

masterAcc = matrix(nrow = iterations, ncol = numks)

for(j in 1:iterations)
{
  trainIndices = sample(1:dim(AleIPA)[1],round(splitPerc * dim(AleIPA)[1]))
  train = AleIPA[trainIndices,]
  test = AleIPA[-trainIndices,]
  for(i in 1:numks)
  {
    classifications = knn(train[,c(3,4)],test[,c(3,4)],train$Style_Type, prob = TRUE, k = i)
    table(classifications,test$Style_Type)
    CM = confusionMatrix(table(classifications,test$Style_Type))
    masterAcc[j,i] = CM$overall[1]
  }
  
}

MeanAcc = colMeans(masterAcc)

#External CV Method
#k=6 86.13% accuracy
MeanAcc = as.data.frame(MeanAcc)
MeanAcc$k = 1:90

MeanAcc%>%
  ggplot(aes(x=k,y=MeanAcc))+
  geom_line()

##Internal CV with kNN
iterations = 200
numks = 90

masterAcc = matrix(nrow = iterations, ncol = numks)

for(i in 1:iterations)
{
  for(j in 1:numks)
  {
    classifications = knn.cv(AleIPA[,c(3,4)], AleIPA$Style_Type, prob = TRUE, k = j)
    table(classifications,AleIPA$Style_Type)
    CM = confusionMatrix(table(classifications,AleIPA$Style_Type))
    masterAcc[i,j] = CM$overall[1]
  }
  
}

MeanAcc = colMeans(masterAcc)

#Internal CV Method
#k=8 86.66% accuracy
MeanAcc = as.data.frame(MeanAcc)
MeanAcc$k = 1:90

MeanAcc%>%
  ggplot(aes(x=k,y=MeanAcc))+
  geom_line()